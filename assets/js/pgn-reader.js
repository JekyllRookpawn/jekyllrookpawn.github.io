!function(){"use strict";if("function"!=typeof Chess||"function"!=typeof Chessboard||!window.PGNCore)return;const e=PGNCore;class t{constructor(t){this.wrapper=t,this.board=null,this.moveSpans=[],this.movesContainer=null,this.mainlineMoves=[],this.mainlineIndex=-1,this.lastFen=null,this.startFen=new Chess().fen(),this.initBoard(),this.bindKeys()}initBoard(){const t=this.wrapper.querySelector(".pgn-reader-board");this.board=Chessboard(t,{position:"start",draggable:!1,pieceTheme:e.PIECE_THEME_URL,appearSpeed:200,moveSpeed:200,snapSpeed:25,snapbackSpeed:50}),this.lastFen=this.startFen}collectMoves(){this.movesContainer=this.wrapper.querySelector(".pgn-reader-right"),this.moveSpans=Array.from(this.wrapper.querySelectorAll(".reader-move")),this.mainlineMoves=this.moveSpans.filter(e=>"1"===e.dataset.mainline)}goto(e,t){if(!(e<0||e>=this.moveSpans.length)){const s=this.moveSpans[e],o=s.dataset.fen;t?this.board.position(o,!0):this.board.position(o,!1),this.lastFen=o,this.mainlineIndex=this.mainlineMoves.indexOf(s),this.moveSpans.forEach(e=>e.classList.toggle("reader-move-active",e===s)),this.movesContainer&&this.movesContainer.scrollTo({top:s.offsetTop-this.movesContainer.offsetTop-this.movesContainer.clientHeight/3,behavior:"smooth"})}}next(){this.mainlineMoves.length&&(this.mainlineIndex=Math.min(this.mainlineIndex+1,this.mainlineMoves.length-1),this.goto(this.moveSpans.indexOf(this.mainlineMoves[this.mainlineIndex]),!0))}prev(){this.mainlineMoves.length&&(this.mainlineIndex=Math.max(this.mainlineIndex-1,0),this.goto(this.moveSpans.indexOf(this.mainlineMoves[this.mainlineIndex]),!0))}bindKeys(){t._keysBound||(t._keysBound=!0,window.addEventListener("keydown",e=>{const t=(e.target.tagName||"").toLowerCase();"input"!==t&&"textarea"!==t&&("ArrowRight"===e.key&&(e.preventDefault(),this.next()),"ArrowLeft"===e.key&&(e.preventDefault(),this.prev()))}))}}class s{constructor(t){t.__pgnReader||(t.__pgnReader=!0,this.sourceEl=t,this.wrapper=document.createElement("div"),this.wrapper.className="pgn-reader-block",this.build(),this.applyFigurines(),this.board=new t(this.wrapper),this.board.collectMoves(),this.bindMoveClicks())}static split(e){const t=e.split(/\r?\n/),s=[],o=[];let i=!0;return t.forEach(e=>{const t=e.trim();i&&t.startsWith("[")&&t.endsWith("]")?s.push(e):i&&""===t?i=!1:(i=!1,o.push(e))}),{headers:s,moveText:o.join(" ").replace(/\s+/g," ").trim()}}build(){const t=e.normalizeFigurines(this.sourceEl.textContent.trim()),{headers:s,moveText:o}=s.split(t);new Chess().load_pgn(t,{sloppy:!0}),this.wrapper.innerHTML='<div class="pgn-reader-header"></div><div class="pgn-reader-cols"><div class="pgn-reader-left"><div class="pgn-reader-board"></div></div><div class="pgn-reader-right"></div></div>',this.sourceEl.replaceWith(this.wrapper)}bindMoveClicks(){this.wrapper.querySelectorAll(".reader-move").forEach((e,t)=>{e.style.cursor="pointer",e.addEventListener("click",()=>this.board.goto(t,!1))})}applyFigurines(){const e={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(t=>{const s=t.textContent.match(/^([KQRBN])(.+)/);s&&(t.textContent=e[s[1]]+s[2])})}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pgn-reader").forEach(e=>new s(e))})}();