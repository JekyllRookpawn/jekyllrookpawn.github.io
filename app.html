<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
*{box-sizing:border-box}
body{margin:0;background:#0f1115;color:#e6e6e6;font-family:system-ui}
.wrap{padding:12px}
.main{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.main{grid-template-columns:560px 1fr}}
#board{width:min(92vw,560px);margin:0 auto}

.moves{font-size:18px;line-height:1.9}
.fullmove{display:grid;grid-template-columns:3ch auto auto;column-gap:6px}
.num{opacity:.65;text-align:right}
.half{cursor:pointer;padding:2px 4px;border-radius:6px}
.half.active{background:#3a7afe;color:#fff}
.variation{margin-left:26px;padding-left:10px;border-left:2px dashed #444}
</style>
</head>

<body>

<div class="wrap">
  <div class="main">
    <div><div id="board"></div></div>
    <div class="moves" id="moves"></div>
  </div>
</div>

<script>
(() => {

const moves=document.getElementById("moves");
const FIG={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};
const figSAN=s=>s.replace(/^[KQRBN]/,p=>FIG[p]||p);

let ID=1;
class Node{
  constructor(san,parent,fen){
    this.id="n"+ID++;
    this.san=san;
    this.parent=parent;
    this.fen=fen;
    this.next=null;
    this.vars=[];
  }
}

const chess=new Chess();
const root=new Node(null,null,chess.fen());
let cursor=root;

const board=Chessboard("board",{
  position:"start",
  draggable:true,
  pieceTheme:"https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
  onDrop
});

function rebuildTo(node){
  chess.load(node?.fen||root.fen);
  board.position(chess.fen());
}

function onDrop(from,to){
  const t=new Chess(chess.fen());
  const m=t.move({from,to,promotion:"q"});
  if(!m) return "snapback";
  applyMove(m.san,t.fen());
}

function applyMove(san,fen){
  let n;
  if(cursor.next && cursor.next.san===san){
    n=cursor.next;
  }else{
    n=new Node(san,cursor,fen);
    if(cursor.next) cursor.vars.push(n);
    else cursor.next=n;
  }
  n.fen=fen;
  cursor=n;
  rebuildTo(n);
  render();
}

function render(){
  moves.innerHTML="";
  renderMain(root,1,moves);
}

function renderMain(start,moveNo,wrap){
  let n=start.next;
  while(n){
    const row=document.createElement("div");
    row.className="fullmove";

    const num=document.createElement("div");
    num.className="num";
    num.textContent=moveNo+".";
    row.appendChild(num);

    const wCell=document.createElement("div");
    const w=n;
    wCell.appendChild(makeHalf(w));
    n=w.next;
    row.appendChild(wCell);

    const bCell=document.createElement("div");
    if(n){
      const b=n;
      bCell.appendChild(makeHalf(b));
      n=b.next;
    }
    row.appendChild(bCell);

    wrap.appendChild(row);

    renderVariations(w,moveNo,true,wrap);
    if(w.next) renderVariations(w.next,moveNo,false,wrap);

    moveNo++;
  }
}

function renderVariations(node,moveNo,isWhite,wrap){
  const seen=new Set();
  node.vars.forEach(v=>{
    if(seen.has(v.san)) return;
    seen.add(v.san);

    const d=document.createElement("div");
    d.className="variation";
    wrap.appendChild(d);

    renderVariationLine(v,moveNo,isWhite,d);
  });
}

function renderVariationLine(start,moveNo,isWhite,wrap){
  let n=start;

  while(n){
    const row=document.createElement("div");
    row.className="fullmove";

    const num=document.createElement("div");
    num.className="num";
    num.textContent=isWhite ? moveNo+"." : moveNo+"...";
    row.appendChild(num);

    if(isWhite){
      const wCell=document.createElement("div");
      wCell.appendChild(makeHalf(n));
      row.appendChild(wCell);

      const bCell=document.createElement("div");
      if(n.next){
        bCell.appendChild(makeHalf(n.next));
        n=n.next.next;
      }else{
        n=null;
      }
      row.appendChild(bCell);
    }else{
      row.appendChild(document.createElement("div"));
      const bCell=document.createElement("div");
      bCell.appendChild(makeHalf(n));
      row.appendChild(bCell);
      n=n.next;
    }

    wrap.appendChild(row);
    moveNo++;
    isWhite=true;
  }
}

function makeHalf(node){
  const span=document.createElement("span");
  span.className="half"+(node===cursor?" active":"");
  span.textContent=figSAN(node.san);
  span.onclick=()=>{cursor=node;rebuildTo(node);render();};
  return span;
}

render();

})();
</script>

</body>
</html>
