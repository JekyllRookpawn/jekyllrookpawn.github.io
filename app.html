<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
*{box-sizing:border-box}
body{margin:0;background:#0f1115;color:#e6e6e6;font-family:system-ui}
.top{padding:10px 14px;background:#171a21;border-bottom:1px solid #222;display:flex;gap:10px}
.top img{width:22px;filter:invert(1)}
.wrap{padding:12px}
.main{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.main{grid-template-columns:560px 1fr}}
.controls{display:flex;gap:6px;justify-content:center}
.controls button{padding:10px;border:none;border-radius:10px;background:#1f2430;color:#ddd}
.card{border:1px solid #222;border-radius:12px}
.card .head{padding:10px;background:#141820;border-bottom:1px solid #222;display:flex;justify-content:space-between}
.tabs{display:flex;gap:6px}
.tabBtn{border:none;background:#1f2430;color:#ddd;padding:6px 10px;border-radius:999px}
.tabBtn.active{background:#3a7afe;color:#fff}
.moves{font-size:18px;line-height:2.1}
.move{display:inline-block;padding:2px 6px;border-radius:7px;cursor:pointer}
.move.active{background:#3a7afe;color:#fff}
.variation{margin-left:26px;border-left:2px dashed #444;padding-left:10px}
.commentRow{margin:4px 0 10px 18px;padding:6px 8px;border-left:3px solid #3a7afe;background:#121724}
.pgnBox{width:100%;height:320px;background:#0f1115;color:#e6e6e6;border:1px solid #222;border-radius:12px;padding:12px}
#tooltip{position:absolute;display:none;background:#141820;border:1px solid #2a3150;border-radius:10px;padding:8px;z-index:1000}
#tooltip .row{display:flex;gap:6px}
#tooltip button{background:#1f2430;border:none;border-radius:8px;padding:6px 8px;color:#ddd}
#tooltip textarea{width:200px;min-height:70px;background:#0f1115;color:#e6e6e6;border:1px solid #2a3150;border-radius:8px;padding:8px}
</style>
</head>

<body>

<div class="top">
  <img src="https://jekyllchess.github.io/assets/favicon.png">
  <div>JekyllChess PGN App</div>
</div>

<div class="wrap">
<div class="main">

<div>
  <div id="board"></div>
  <div class="controls">
    <button id="btnStart">⏮</button>
    <button id="btnPrev">◀</button>
    <button id="btnNext">▶</button>
    <button id="btnEnd">⏭</button>
  </div>
</div>

<div class="card">
  <div class="head">
    <div>Move list</div>
    <div class="tabs">
      <button id="tabMoves" class="tabBtn active">Move list</button>
      <button id="tabPGN" class="tabBtn">PGN text</button>
    </div>
  </div>
  <div class="body">
    <div id="panelMoves"><div id="moves" class="moves"></div></div>
    <div id="panelPGN" style="display:none">
      <textarea id="pgnText" class="pgnBox"></textarea>
    </div>
  </div>
</div>

</div>
</div>

<div id="tooltip"></div>

<script>
const FIG={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};
const figSAN=s=>s.replace(/^[KQRBN]/,p=>FIG[p]||p).replace(/=([QRBN])/g,(_,p)=>"="+FIG[p]);

let NODE=1;
class Node{constructor(s,p){this.id="n"+NODE++;this.san=s;this.p=p;this.n=null;this.v=[];this.c=""}}
const root=new Node(null,null);
let cursor=root,nav=null;

const chess=new Chess();
const board=Chessboard("board",{
  position:"start",
  draggable:true,
  pieceTheme:"https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
  onDrop
});

const tooltip=document.getElementById("tooltip");
document.body.onclick=()=>tooltip.style.display="none";
tooltip.onclick=e=>e.stopPropagation();

function showPromotion(x,y,cb){
  tooltip.innerHTML="";
  const r=document.createElement("div");r.className="row";
  ["q","r","b","n"].forEach(p=>{
    const b=document.createElement("button");
    b.textContent=FIG[p.toUpperCase()];
    b.onclick=()=>cb(p);
    r.appendChild(b);
  });
  tooltip.appendChild(r);
  tooltip.style.left=x+"px";tooltip.style.top=y+"px";tooltip.style.display="block";
}

function rebuild(n){
  chess.reset();
  const a=[];
  while(n&&n!==root){a.push(n);n=n.p}
  a.reverse().forEach(m=>chess.move(m.san));
  board.position(chess.fen(),false);
}

function onDrop(from,to){
  const piece=chess.get(from);
  const fenBefore=chess.fen();
  const curBefore=cursor;

  // PROMOTION (correct pattern)
  if(piece&&piece.type==="p"&&(to[1]==="8"||to[1]==="1")){
    const guard=new Chess(fenBefore);
    if(!guard.move({from,to,promotion:"q"})) return "snapback";

    // let board drop pawn, but DO NOT commit yet
    showPromotion(boardEl.getBoundingClientRect().left+260,200,(promo)=>{
      chess.load(fenBefore);
      const m=chess.move({from,to,promotion:promo});
      cursor=curBefore;
      const nn=new Node(m.san,cursor);
      if(!cursor.n) cursor.n=nn; else cursor.v.push(nn);
      cursor=nn;
      board.position(chess.fen(),false);
      render();
    });
    return;
  }

  const test=new Chess(fenBefore);
  const m=test.move({from,to});
  if(!m) return "snapback";

  chess.move(m.san);
  const nn=new Node(m.san,cursor);
  if(!cursor.n) cursor.n=nn; else cursor.v.push(nn);
  cursor=nn;
  render();
}

function render(){
  const d=document.getElementById("moves");
  d.innerHTML="";
  let n=root.n;
  let ply=0;
  while(n){
    const s=document.createElement("span");
    s.className="move";
    s.textContent=((ply%2===0)?Math.floor(ply/2)+1+". ":"")+figSAN(n.san)+" ";
    d.appendChild(s);
    n=n.n; ply++;
  }
}
render();
</script>
</body>
</html>
