<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0f1115;
  color:#e6e6e6;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
.top{
  padding:10px 14px;
  background:#171a21;
  border-bottom:1px solid #222;
  display:flex;
  gap:10px;
  align-items:center;
}
.top img{width:22px;filter:invert(1)}

.wrap{padding:12px}
.main{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.main{grid-template-columns:560px 1fr}}
#board{width:min(92vw,560px);margin:0 auto}

.controls{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.controls button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#1f2430;
  color:#ddd;
  cursor:pointer;
  font-size:15px;
}
.controls button:disabled{opacity:.4;cursor:default}

.card{
  border:1px solid #222;
  border-radius:12px;
  overflow:hidden;
}
.cardHead{
  padding:10px 12px;
  background:#141820;
  border-bottom:1px solid #222;
  font-weight:700;
}
.cardBody{padding:12px}

.moves{font-size:18px;line-height:2}
.move{
  display:inline-block;
  padding:2px 6px;
  border-radius:7px;
  cursor:pointer;
  user-select:none;
}
.move:hover{background:#20263a}
.move.active{background:#3a7afe;color:#fff}

.variation{
  margin-left:26px;
  padding-left:10px;
  border-left:2px dashed #444;
  opacity:.95;
}

/* COMMENTS DISTINCT */
.commentRow{
  margin:6px 0 10px 18px;
  padding:6px 10px;
  border-left:4px solid #3a7afe;
  border-radius:8px;
  background:#121724;
  color:#cfd6ff;
  font-size:14px;
  font-style:italic;
  line-height:1.6;
}

/* promotion popup */
#pop{
  position:fixed;
  z-index:9999;
  background:#0b0f18;
  border:1px solid #2a3350;
  border-radius:12px;
  padding:8px;
  display:none;
}
#pop .row{display:flex;gap:8px}
#pop button{
  width:44px;height:44px;
  border-radius:10px;
  border:none;
  background:#1f2430;
  color:#e6e6e6;
  font-size:22px;
  cursor:pointer;
}
#pop button:hover{background:#2a3150}
</style>
</head>

<body>

<div class="top">
  <img src="https://jekyllchess.github.io/assets/favicon.png">
  <div>JekyllChess PGN App</div>
</div>

<div class="wrap">
  <div class="main">
    <div>
      <div id="board"></div>
      <div class="controls">
        <button id="btnStart" type="button">⏮</button>
        <button id="btnPrev"  type="button">◀</button>
        <button id="btnNext"  type="button">▶</button>
        <button id="btnEnd"   type="button">⏭</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">Move list</div>
      <div class="cardBody">
        <div id="moves" class="moves"></div>
      </div>
    </div>
  </div>
</div>

<div id="pop"></div>

<script>
(() => {
  const FIG={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};
  const figSAN=s=>s.replace(/^[KQRBN]/,p=>FIG[p]||p).replace(/=([QRBN])/g,(_,p)=>"="+FIG[p]);

  let ID=1;
  class Node{
    constructor(san,parent){
      this.id="n"+ID++;
      this.san=san;
      this.parent=parent;
      this.next=null;   // mainline
      this.vars=[];     // variation roots
      this.comment="";
    }
  }

  const root=new Node(null,null);

  // cursor = current node (root means start pos)
  let cursor=root;

  // navNode = node on mainline OR null (start)
  let navNode=null;

  const chess=new Chess();
  const board=Chessboard("board",{
    position:"start",
    draggable:true,
    pieceTheme:"https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
    onDrop
  });

  function rebuildTo(node,animate){
    chess.reset();
    if(node===root){
      board.position("start", !!animate);
      return;
    }
    const chain=[];
    let n=node;
    while(n&&n!==root){chain.push(n);n=n.parent}
    chain.reverse().forEach(m=>chess.move(m.san));
    board.position(chess.fen(), !!animate);
  }

  function mainlineArray(){
    const a=[];
    let n=root.next;
    while(n){a.push(n);n=n.next}
    return a;
  }
  function navIndex(){
    if(!navNode) return -1;
    const a=mainlineArray();
    return a.indexOf(navNode);
  }

  function addMove(san){
    if(cursor.next && cursor.next.san===san){
      cursor=cursor.next;
      if(isOnMainline(cursor)) navNode=cursor;
      return;
    }
    const v=cursor.vars.find(x=>x.san===san);
    if(v){cursor=v;return}
    const n=new Node(san,cursor);
    if(cursor.next) cursor.vars.push(n);
    else cursor.next=n;
    cursor=n;
    if(isOnMainline(cursor)) navNode=cursor;
  }

  function isOnMainline(node){
    let n=root.next;
    while(n){ if(n===node) return true; n=n.next; }
    return false;
  }

  /* PROMOTION (unchanged, confirmed working) */
  const pop=document.getElementById("pop");
  let pendingFen=null, pendingMove=null;

  function openPromotion(from,to){
    pop.innerHTML="";
    const row=document.createElement("div");
    row.className="row";
    ["q","r","b","n"].forEach(p=>{
      const b=document.createElement("button");
      b.textContent=FIG[p.toUpperCase()];
      b.onclick=()=>commitPromotion(p);
      row.appendChild(b);
    });
    pop.appendChild(row);
    const r=document.getElementById("board").getBoundingClientRect();
    pop.style.left=(r.left+r.width/2)+"px";
    pop.style.top=(r.top+r.height/2)+"px";
    pop.style.transform="translate(-50%,-50%)";
    pop.style.display="block";
    pendingMove={from,to};
  }

  function commitPromotion(p){
    chess.load(pendingFen);
    const m=chess.move({from:pendingMove.from,to:pendingMove.to,promotion:p});
    if(!m){pop.style.display="none";return}
    addMove(m.san);
    pop.style.display="none";
    rebuildTo(cursor,false);
    render();
  }

  function onDrop(from,to){
    pop.style.display="none";
    const test=new Chess(chess.fen());
    const mQ=test.move({from,to,promotion:"q"});
    if(!mQ) return "snapback";
    if(mQ.flags.includes("p")){
      pendingFen=chess.fen();
      openPromotion(from,to);
      return "snapback";
    }
    const m=chess.move({from,to,promotion:"q"});
    if(!m) return "snapback";
    addMove(m.san);
    rebuildTo(cursor,false);
    render();
  }

  /* RENDER */
  const movesDiv=document.getElementById("moves");

  function render(){
    movesDiv.innerHTML="";
    function line(start,ply,container){
      let n=start.next;
      while(n){
        const span=document.createElement("span");
        span.className="move"+(n===cursor?" active":"");
        span.textContent=((ply%2===0)?Math.floor(ply/2)+1+". ":"")+figSAN(n.san)+" ";
        span.onclick=e=>{
          e.stopPropagation();
          cursor=n;
          if(isOnMainline(n)) navNode=n;
          rebuildTo(n,true);
          render();
        };
        container.appendChild(span);

        if(n.comment){
          const c=document.createElement("div");
          c.className="commentRow";
          c.textContent=n.comment;
          container.appendChild(c);
        }

        if(n.vars.length){
          n.vars.forEach(v=>{
            const d=document.createElement("div");
            d.className="variation";
            container.appendChild(d);
            line({next:v}, ply+1, d);
          });
        }

        n=n.next; ply++;
      }
    }
    line(root,0,movesDiv);
    updateNavButtons();
  }

  /* NAV BUTTONS + DISABLE STATES */
  const btnStart=document.getElementById("btnStart");
  const btnPrev=document.getElementById("btnPrev");
  const btnNext=document.getElementById("btnNext");
  const btnEnd=document.getElementById("btnEnd");

  function updateNavButtons(){
    const a=mainlineArray();
    const i=navIndex();
    const has=a.length>0;

    btnStart.disabled = !has || i===-1;
    btnPrev.disabled  = !has || i===-1;

    btnNext.disabled  = !has || i===a.length-1;
    btnEnd.disabled   = !has || i===a.length-1;
  }

  function goStart(){
    navNode=null;
    cursor=root;
    rebuildTo(root,true);
    render();
  }

  function goEnd(){
    const a=mainlineArray();
    if(!a.length) return goStart();
    navNode=a[a.length-1];
    cursor=navNode;
    rebuildTo(cursor,true);
    render();
  }

  function goPrev(){
    const a=mainlineArray();
    const i=navIndex();
    if(i===-1) return;
    if(i===0) return goStart();
    navNode=a[i-1];
    cursor=navNode;
    rebuildTo(cursor,true);
    render();
  }

  function goNext(){
    const a=mainlineArray();
    if(!a.length) return;
    const i=navIndex();
    if(i===-1){
      navNode=a[0];
    }else if(i<a.length-1){
      navNode=a[i+1];
    }else{
      return;
    }
    cursor=navNode;
    rebuildTo(cursor,true);
    render();
  }

  btnStart.onclick=goStart;
  btnPrev.onclick=goPrev;
  btnNext.onclick=goNext;
  btnEnd.onclick=goEnd;

  /* KEYBOARD: call nav functions directly */
  document.addEventListener("keydown",e=>{
    const el=document.activeElement;
    const typing=el && (el.tagName==="INPUT" || el.tagName==="TEXTAREA");
    if(typing) return;
    if(pop.style.display==="block") return;

    if(e.key==="ArrowLeft"){ e.preventDefault(); goPrev(); }
    else if(e.key==="ArrowRight"){ e.preventDefault(); goNext(); }
    else if(e.key==="Home"){ e.preventDefault(); goStart(); }
    else if(e.key==="End"){ e.preventDefault(); goEnd(); }
  });

  render();
  rebuildTo(root,false);
})();
</script>

</body>
</html>
