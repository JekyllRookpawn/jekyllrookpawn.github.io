<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PGN App</title>

<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
}

.app {
  max-width: 900px;
  margin: 0 auto;
  padding: 1rem;
}

#board {
  width: 360px;
  max-width: 100%;
  margin-bottom: 1rem;
}

.move {
  cursor: pointer;
  padding: 0 0.15rem;
}

.move.active {
  background: #ffe08a;
}
</style>
</head>

<body>

<div class="app">

<h1>PGN Viewer</h1>
<div id="gameLine">—</div>

<div id="board"></div>

<div class="controls">
  <button id="btnFirst">⏮</button>
  <button id="btnPrev">◀</button>
  <button id="btnPlay">▶️</button>
  <button id="btnNext">▶</button>
  <button id="btnLast">⏭</button>

  <label>
    Speed
    <input id="speed" type="range" min="200" max="1200" step="50" value="450">
  </label>

  <button id="btnFlip">Flip</button>
</div>

<div id="moves"></div>

<!-- PGN DATA (Jekyll-safe, invisible) -->
<script type="text/plain" id="pgn-data">
[Event "Demo Game"]
[Site "Istanbul"]
[Date "2025.12.16"]
[Round "-"]
[White "White Player"]
[Black "Black Player"]
[Result "1-0"]

1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 4. Ba4 Nf6 5. O-O Be7 6. Re1 b5 7. Bb3 d6 8. c3 O-O 9. h3 1-0
</script>

</div>

<script>
(() => {
  "use strict";

  const pgnText =
    document.getElementById("pgn-data").textContent.trim();

  const chess = new Chess();
  chess.load_pgn(pgnText, { sloppy: true });

  const moves = chess.history({ verbose: true });
  chess.reset();

  const board = Chessboard("board", {
    position: "start",
    pieceTheme:
      "https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png",
    moveSpeed: 200,
    snapSpeed: 30
  });

  const movesDiv = document.getElementById("moves");
  const gameLine = document.getElementById("gameLine");

  const headers = chess.header();
  gameLine.textContent =
    `${headers.White || ""} – ${headers.Black || ""}`.trim();

  let index = -1;
  let autoplay = null;
  let orientation = "white";

  moves.forEach((m, i) => {
    const span = document.createElement("span");
    span.className = "move";
    span.textContent =
      (m.color === "w" ? `${Math.floor(i / 2) + 1}. ` : "") + m.san + " ";
    span.onclick = () => goto(i);
    movesDiv.appendChild(span);
  });

  function highlight(i) {
    document.querySelectorAll(".move")
      .forEach((m, k) => m.classList.toggle("active", k === i));
  }

  function resetBoard() {
    chess.reset();
    board.position("start", true);
    index = -1;
    highlight(-1);
  }

  function goto(i) {
    chess.reset();
    for (let j = 0; j <= i; j++) chess.move(moves[j]);
    board.position(chess.fen(), true);
    index = i;
    highlight(i);
  }

  function next() {
    if (index < moves.length - 1) {
      goto(index + 1);
    } else if (autoplay) {
      clearInterval(autoplay);
      autoplay = null;
      btnPlay.textContent = "▶";
    }
  }

  function prev() {
    if (index > 0) goto(index - 1);
    else resetBoard();
  }

  btnFirst.onclick = resetBoard;
  btnPrev.onclick = prev;
  btnNext.onclick = next;
  btnLast.onclick = () => goto(moves.length - 1);

  btnPlay.onclick = () => {
    if (autoplay) {
      clearInterval(autoplay);
      autoplay = null;
      btnPlay.textContent = "▶";
      return;
    }
    btnPlay.textContent = "⏸";
    autoplay = setInterval(next, +speed.value);
  };

  btnFlip.onclick = () => {
    orientation = orientation === "white" ? "black" : "white";
    board.orientation(orientation);
  };

})();
</script>

</body>
</html>
