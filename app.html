<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0f1115;
  color:#e6e6e6;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
.top{
  padding:10px 14px;
  background:#171a21;
  border-bottom:1px solid #222;
  display:flex;
  gap:10px;
  align-items:center;
}
.top img{width:22px;filter:invert(1)}

.wrap{padding:12px}
.main{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.main{grid-template-columns:560px 1fr}}
#board{width:min(92vw,560px);margin:0 auto}

.controls{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.controls button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#1f2430;
  color:#ddd;
  cursor:pointer;
  font-size:15px;
}
.controls button:disabled{opacity:.4;cursor:default}

.card{
  border:1px solid #222;
  border-radius:12px;
  overflow:hidden;
}
.cardHead{
  padding:10px 12px;
  background:#141820;
  border-bottom:1px solid #222;
  font-weight:700;
}
.cardBody{padding:12px}

.moves{font-size:18px;line-height:2}
.move{
  display:inline-block;
  padding:2px 6px;
  border-radius:7px;
  cursor:pointer;
  user-select:none;
}
.move:hover{background:#20263a}
.move.active{background:#3a7afe;color:#fff}

.variation{
  margin-left:26px;
  padding-left:10px;
  border-left:2px dashed #444;
}

.commentRow{
  margin:6px 0 10px 18px;
  padding:6px 10px;
  border-left:4px solid #3a7afe;
  border-radius:8px;
  background:#121724;
  color:#cfd6ff;
  font-size:14px;
  font-style:italic;
}
</style>
</head>

<body>

<div class="top">
  <img src="https://jekyllchess.github.io/assets/favicon.png">
  <div>JekyllChess PGN App</div>
</div>

<div class="wrap">
  <div class="main">
    <div>
      <div id="board"></div>
      <div class="controls">
        <button id="btnStart">⏮</button>
        <button id="btnPrev">◀</button>
        <button id="btnNext">▶</button>
        <button id="btnEnd">⏭</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">Move list</div>
      <div class="cardBody">
        <div id="moves" class="moves"></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const FIG={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};
  const figSAN=s=>s.replace(/^[KQRBN]/,p=>FIG[p]||p).replace(/=([QRBN])/g,(_,p)=>"="+FIG[p]);

  let ID=1;
  class Node{
    constructor(san,parent){
      this.id="n"+ID++;
      this.san=san;
      this.parent=parent;
      this.next=null;
      this.vars=[];
      this.comment="";
    }
  }

  const root=new Node(null,null);
  let cursor=root;
  let navNode=null;

  const chess=new Chess();
  const board=Chessboard("board",{
    position:"start",
    draggable:true,
    pieceTheme:"https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
    onDrop
  });

  function rebuildTo(node,animate){
    chess.reset();
    if(node===root){
      board.position("start",!!animate);
      return;
    }
    const chain=[];
    let n=node;
    while(n&&n!==root){chain.push(n);n=n.parent}
    chain.reverse().forEach(m=>chess.move(m.san));
    board.position(chess.fen(),!!animate);
  }

  function addMove(san){
    if(cursor.next && cursor.next.san===san){
      cursor=cursor.next;
      navNode=cursor;
      return;
    }
    const v=cursor.vars.find(x=>x.san===san);
    if(v){cursor=v;return}
    const n=new Node(san,cursor);
    if(cursor.next) cursor.vars.push(n);
    else cursor.next=n;
    cursor=n;
    navNode=cursor;
  }

  function onDrop(from,to){
    const test=new Chess(chess.fen());
    const m=test.move({from,to,promotion:"q"});
    if(!m) return "snapback";
    addMove(m.san);
    rebuildTo(cursor,false);
    render();
  }

  const movesDiv=document.getElementById("moves");

  function render(){
    movesDiv.innerHTML="";
    function line(start,ply,container){
      let n=start.next;
      while(n){
        const span=document.createElement("span");
        span.className="move"+(n===cursor?" active":"");
        span.textContent=((ply%2===0)?Math.floor(ply/2)+1+". ":"")+figSAN(n.san)+" ";
        span.onclick=e=>{
          e.stopPropagation();
          cursor=n;
          if(isOnMainline(n)) navNode=n;
          render();
          requestAnimationFrame(()=>rebuildTo(n,true));
        };
        container.appendChild(span);

        if(n.comment){
          const c=document.createElement("div");
          c.className="commentRow";
          c.textContent=n.comment;
          container.appendChild(c);
        }

        if(n.vars.length){
          n.vars.forEach(v=>{
            const d=document.createElement("div");
            d.className="variation";
            container.appendChild(d);
            line({next:v},ply+1,d);
          });
        }

        n=n.next; ply++;
      }
    }
    line(root,0,movesDiv);
  }

  function isOnMainline(node){
    let n=root.next;
    while(n){ if(n===node) return true; n=n.next; }
    return false;
  }

  render();
  rebuildTo(root,false);
})();
</script>

</body>
</html>
